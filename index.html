<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VaultiQ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<!-- Google -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<style>
:root{
  --bg:#f4f6fa;--card:#fff;--primary:#007aff;
  --text:#0f172a;--muted:#64748b;--radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",sans-serif;
  background:var(--bg);color:var(--text);
}
header{
  padding:16px 20px;
  background:var(--card);
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 2px 14px rgba(0,0,0,.06);
}
h2{margin:0}
button{
  background:var(--primary);color:#fff;border:none;
  padding:10px 14px;border-radius:12px;font-size:14px;
}
input,textarea{
  width:100%;padding:12px;border:none;border-radius:12px;
  margin:8px 0;font-size:15px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.hidden{display:none}
.container{padding:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:16px;
}
.card{
  background:var(--card);padding:16px;border-radius:var(--radius);
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
.item{
  background:#f8fafc;padding:12px;border-radius:12px;margin-bottom:8px;
}
.badge{
  background:#fee2e2;color:#991b1b;
  padding:6px 10px;border-radius:999px;font-size:12px;
  display:inline-block;margin-bottom:10px;
}
.qr{display:flex;justify-content:center;margin:16px 0}
</style>
</head>

<body>

<header>
  <h2>VaultiQ</h2>
</header>

<!-- LOGIN -->
<div class="container" id="loginView">
  <h1>One QR. All that matters.</h1>
  <p style="color:var(--muted)">Emergency-ready document vault</p>
  <div id="loginBtn"></div>
</div>

<!-- DASHBOARD -->
<div class="container hidden" id="dashboard">
  <h3>Your Vault</h3>
  <div class="grid" id="folderGrid"></div>
</div>

<!-- FOLDER VIEW -->
<div class="container hidden" id="folderView">
  <button onclick="goBack()">‚Üê Back</button>
  <h2 id="folderTitle"></h2>

  <input type="file" id="fileInput">
  <button onclick="uploadFile()">Upload File</button>

  <h3>Files</h3>
  <div id="fileList"></div>

  <h3>Emergency Contacts</h3>
  <textarea id="contacts" placeholder="Name ‚Äì Phone"></textarea>
  <button onclick="saveContacts()">Save Contacts</button>

  <h3>QR Codes</h3>
  <button onclick="makeFolderQR()">Folder QR</button>
  <button onclick="makeEmergencyQR()">Emergency QR</button>
  <div class="qr"><canvas id="qr"></canvas></div>
</div>

<!-- EMERGENCY VIEW -->
<div class="container hidden" id="emergencyView">
  <span class="badge">üö® Emergency Information</span>
  <h2>Contacts</h2>
  <div id="emergencyContacts"></div>
  <h2>Documents</h2>
  <div id="emergencyFiles"></div>
</div>

<script>
/* ================= CONFIG ================= */
const CLIENT_ID="913571877994-rgjihjtio40kf0bnamntmf9qjlknlm4d.apps.googleusercontent.com";
const SCOPES="https://www.googleapis.com/auth/drive.file";
let tokenClient, accessToken, rootId, activeFolder;

/* ================= ROUTER ================= */
if(location.hash.startsWith("#/emergency/")){
  showEmergency(location.hash.split("/")[2]);
}

/* ================= GOOGLE LOGIN ================= */
google.accounts.id.initialize({
  client_id:CLIENT_ID,
  callback:()=>{}
});
google.accounts.id.renderButton(loginBtn,{theme:"outline",size:"large"});

tokenClient = google.accounts.oauth2.initTokenClient({
  client_id:CLIENT_ID,
  scope:SCOPES,
  callback:(token)=>{
    accessToken = token.access_token;
    initDrive();
  }
});

loginBtn.onclick = () => tokenClient.requestAccessToken();

/* ================= DRIVE INIT ================= */
function initDrive(){
  gapi.load("client", async ()=>{
    await gapi.client.init({});
    gapi.client.setToken({access_token:accessToken});
    loginView.classList.add("hidden");
    dashboard.classList.remove("hidden");
    await ensureRoot();
    loadFolders();
  });
}

/* ================= ROOT + FOLDERS ================= */
async function ensureRoot(){
  const res = await gapi.client.drive.files.list({
    q:"name='VaultiQ' and mimeType='application/vnd.google-apps.folder'"
  });
  if(res.result.files.length){
    rootId = res.result.files[0].id;
    return;
  }
  const root = await gapi.client.drive.files.create({
    resource:{name:"VaultiQ",mimeType:"application/vnd.google-apps.folder"}
  });
  rootId = root.result.id;
  for(const n of ["Automobile","Personal","Education","Health"]){
    await gapi.client.drive.files.create({
      resource:{
        name:n,
        mimeType:"application/vnd.google-apps.folder",
        parents:[rootId]
      }
    });
  }
}

/* ================= DASHBOARD ================= */
async function loadFolders(){
  const res = await gapi.client.drive.files.list({
    q:`'${rootId}' in parents`
  });
  folderGrid.innerHTML="";
  res.result.files.forEach(f=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<b>${f.name}</b>`;
    c.onclick=()=>openFolder(f);
    folderGrid.appendChild(c);
  });
}

function openFolder(f){
  activeFolder=f;
  dashboard.classList.add("hidden");
  folderView.classList.remove("hidden");
  folderTitle.textContent=f.name;
  loadFiles();
  loadContacts();
}

/* ================= FILES ================= */
async function loadFiles(){
  const res=await gapi.client.drive.files.list({
    q:`'${activeFolder.id}' in parents`
  });
  fileList.innerHTML="";
  res.result.files.forEach(f=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=f.name;
    fileList.appendChild(d);
  });
}

async function uploadFile(){
  const file=fileInput.files[0];
  if(!file)return;
  const meta={name:file.name,parents:[activeFolder.id]};
  const form=new FormData();
  form.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
  form.append("file",file);
  await fetch(
    "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
    {method:"POST",headers:{Authorization:"Bearer "+accessToken},body:form}
  );
  loadFiles();
}

/* ================= CONTACTS ================= */
function saveContacts(){
  localStorage.setItem("contacts_"+activeFolder.id,contacts.value);
  alert("Contacts saved");
}
function loadContacts(){
  contacts.value=localStorage.getItem("contacts_"+activeFolder.id)||"";
}

/* ================= QR ================= */
function makeFolderQR(){
  QRCode.toCanvas(qr,location.origin+location.pathname+"#folder="+activeFolder.id,{width:240});
}
function makeEmergencyQR(){
  QRCode.toCanvas(qr,location.origin+location.pathname+"#/emergency/"+activeFolder.id,{width:240});
}

/* ================= EMERGENCY VIEW ================= */
async function showEmergency(folderId){
  loginView.classList.add("hidden");
  dashboard.classList.add("hidden");
  emergencyView.classList.remove("hidden");

  emergencyContacts.textContent =
    localStorage.getItem("contacts_"+folderId) || "No contacts";

  gapi.load("client",async()=>{
    await gapi.client.init({});
    const res=await gapi.client.drive.files.list({
      q:`'${folderId}' in parents`
    });
    emergencyFiles.innerHTML="";
    res.result.files.forEach(f=>{
      const d=document.createElement("div");
      d.className="item";
      d.textContent=f.name;
      emergencyFiles.appendChild(d);
    });
  });
}

function goBack(){
  folderView.classList.add("hidden");
  dashboard.classList.remove("hidden");
}
</script>

</body>
</html>
